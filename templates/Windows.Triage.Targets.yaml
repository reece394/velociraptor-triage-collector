{{ define "GlobTable" }}
  Target,Rule,Glob,Ref
  {{- range .Rules }}
  {{ .Target}},{{ .Name }},"{{ .Glob }}",{{ .Ref -}}
  {{ end }}
{{ end -}}

name: {{ .Config.Name }}
description: |
  This artifact aims to preserve raw files from the endpoint by
  selectively acquiring the most important files for the investigation
  at hand. The artfiact collates multiple rules from sources such as
  the KapeFiles repository.

  Kape is a popular bulk collector tool for triaging a system
  quickly. While KAPE itself is not an opensource tool, the logic it
  uses to decide which files to collect is encoded in YAML files
  hosted on the KapeFiles project
  (https://github.com/EricZimmerman/KapeFiles) and released under an
  MIT license.

  This artifact is automatically generated from these YAML files,
  contributed and maintained by the community. This artifact only
  encapsulates the KAPE "Targets" - basically a bunch of glob
  expressions used for collecting files on the endpoint. We do not
  do any post processing of these files - we just collect them.

  We recommend that timeouts and upload limits be used
  conservatively with this artifact because we can upload really
  vast quantities of data very quickly.

  NOTE:
    This artifact was built from [The Velociraptor Triage
    Repository](https://triage.velocidex.com/docs/)

  ## DropVerySlowRules

  Some rules are very slow due to a recursive search at the higher
  levels (For example a glob such as `C:\**\*.ini` ). These rules
  cause the collection to be very slow as the entire filesystem must
  be searched.

  By default we drop these rules but you can enable them if you
  like. This will cause the collection to be a lot slower.

  ## CollectionPolicy

  The decision on whether to collect the file or simply display
  metadata (like hash etc) is determined by the CollectionPolicy:

  1. ExcludeSigned: If the file is a signed executable, we do not
     collect it.
  2. HashOnly: Do not collect any file - just display their hashes
  3. AllFiles: Collect all files regardless of their types.

  Commit {{ .Commit }} on {{ .Time }}

reference:
  - https://www.kroll.com/en/insights/publications/cyber/kroll-artifact-parser-extractor-kape
  - https://github.com/EricZimmerman/KapeFiles

parameters:
  - name: HighLevelTargets
    description: A shorter list of Meta-Targets
    type: multichoice
    default: "[]"
    choices:
{{- range .TargetFiles }}
    {{- if hasPrefix "_" .Name }}
    - {{ .Name -}}
    {{ end -}}
{{ end }}

  - name: Targets
    type: multichoice
    description: All targets available
    default: "[]"
    choices:
{{- range .TargetFiles }}
    - {{ .Name -}}
{{ end }}

  - name: Devices
    type: json_array
    description: |
      Name of the drive letter to search. You can add multiple drives
      separated with a comma.
    default: '["C:"]'

  - name: CollectionPolicy
    type: choices
    choices:
      - ExcludeSigned
      - HashOnly
      - AllFiles
    default: ExcludeSigned

  - name: DropVerySlowRules
    type: bool
    default: Y
    description: Ignore inefficient targets

  - name: TrustedPathRegex
    type: regex
    default: ^C:\\\\Windows\\\\
    description: |
      Do not hash or upload any adaptive files matching this regex.

  - name: MaxFileSize
    type: int
    description: |
      The max size in bytes of the individual files to collect
      (Default 100Mb).

  - name: MaxHashSize
    type: int
    default: "100000000"
    description: |
      The max size in bytes of the individual files to hash.

  - name: UPLOAD_IS_RESUMABLE
    type: bool
    default: Y
    description: |
      If set the uploads can be resumed if the flow times out or
      errors.

  - name: VSS_MAX_AGE_DAYS
    type: int
    default: 0
    description: |
      If larger than zero we analyze VSS within this many days
      ago. (e.g 7 will analyze all VSS within the last week).  Note
      that when using VSS analysis we have to use the ntfs accessor
      for everything which will be much slower.

  - name: Verbose
    type: bool
    description: |
      Add Verbose debugging logs

  - name: DISABLE_DANGEROUS_API_CALLS
    type: bool
    default: "Y"

  - name: WORKERS
    type: int
    default: "5"
    description: |
      Number of concurrent workers to use for parsing and compressing.

  - name: SlowGlobRegex
    type: hidden
    default: "^\\*\\*"
    description: A regex to eliminate slow globs.

export: |
{{ Indent ( Template "templates/CommonExports.yaml" ) 2 }}

    LET _ExpandedTransforms <= dict(
        `^\\\\SystemRoot\\\\`="%SystemRoot%\\",
        `^system32\\\\`="%SystemRoot%\\System32\\",
        `^{.+}.+`="\\$0",
        `^.:\\\\Program Files[^\\\\]*\\\\[^ ]+`='"$0"',
        `^%[^ ]+%[^ ]+`='"$0"'
      )

    // Extract the binary from the command line
    LET ExpandPath(Path) = lowcase(string=commandline_split(
    command=expand(path=regex_transform(source=Path,
      map=_ExpandedTransforms)))[0])

    {{ range $idx, $r := .Rules -}}
    {{- if $r.VQL -}}
    // {{ .Description }}
    LET Collect{{ $r.Target }}_{{ $r.Name }} =
{{ Indent .VQL 7 -}}
    {{- end -}}
    {{- end }}

    {{- range .TargetFiles -}}
    {{- if .Preamble }}
    // From {{ .Name }}
{{ Indent .Preamble 4 -}}
    {{- end -}}
    {{- end }}

sources:
{{ Template "templates/SearchGlob.yaml" }}
{{ Template "templates/Windows.AllMatchesMetadata.yaml" }}
{{ Template "templates/CommonSources.yaml" }}

{{ Template "templates/ColumnTypes.yaml" }}
