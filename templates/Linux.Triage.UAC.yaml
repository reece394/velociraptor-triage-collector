name: Linux.Triage.UAC
description: |
  NOTE:
    This artifact was built from [The Velociraptor Triage
    Repository](https://triage.velocidex.com/docs/)

  Commit {{ .Commit }} on {{ .Time }}

parameters:
  - name: HighLevelTargets
    description: A shorter list of Meta-Targets
    type: multichoice
    default: "[]"
    choices:
{{- range .TargetFiles }}
    {{- if hasPrefix "_" .Name }}
    - {{ .Name -}}
    {{ end -}}
{{ end }}

  - name: Targets
    type: multichoice
    description: All targets available
    default: "[]"
    choices:
{{- range .TargetFiles }}
    - {{ .Name -}}
{{ end }}

  - name: TrustedPathRegex
    type: regex
    default: "^/usr/bin/"
    description: |
      Do not hash or upload any adaptive files matching this regex.

  - name: MaxFileSize
    type: int
    default: 18446744073709551615
    description: |
      The max size in bytes of the individual files to collect.
      Set to 0 to disable it.

  - name: MaxHashSize
    type: int
    default: "100000000"
    description: |
      The max size in bytes of the individual files to hash.

  - name: DropVerySlowRules
    type: bool
    default: Y
    description: Ignore inefficient targets

  - name: SlowGlobRegex
    type: hidden
    default: "^/**"
    description: A regex to eliminate slow globs.

  - name: WORKERS
    type: int
    default: "5"
    description: |
      Number of concurrent workers to use for parsing and compressing.

  - name: UPLOAD_IS_RESUMABLE
    type: bool
    default: Y
    description: |
      If set the uploads can be resumed if the flow times out or
      errors.

  - name: PreferredAccessor
    default: auto
    description: The accessor to use.

  - name: RootDirectory
    default: /
    description: The root directory to start searching from (can use a mount point for deaddisk analysis).

export: |
{{ Indent ( Template "templates/CommonExports.yaml" ) 2 }}

    // Extract the binary from the command line
    LET ExpandPath(Path) = expand(path=Path)

sources:
{{ Template "templates/SearchGlob.yaml" }}

- name: All Matches Metadata
  query: |
    LET AutoGlobs = SELECT * FROM AllCollections
       WHERE Glob

    // UAC globs may be directories in which case we fetch all the files in them.
    LET AllGlobs = SELECT Type,
        Size,
        OSPath AS SourceFile,
        Btime AS Created,
        Ctime AS Changed,
        Mtime AS Modified,
        Atime AS LastAccessed,
        Data,
        get(item=GlobLookup, field=Globs[0]).Rule AS Rule,
        PreferredAccessor AS Accessor,
        dict(Globs=Globs) AS Data,
        "Glob" AS Type
    FROM foreach(row={
        SELECT *
        FROM glob(globs=AutoGlobs.Glob,
                  accessor=PreferredAccessor,
                  root=RootDirectory)
    }, query={
        SELECT * FROM if(condition=IsDir,
        then={
            SELECT *
            FROM glob(globs="**", root=OSPath,
                      accessor=PreferredAccessor)
        }, else={
            SELECT *, Globs
            FROM stat(accessor=PreferredAccessor, filename=OSPath)
        })
    })

    LET AllResults <= SELECT Type,
                             SourceFile,
                             Size,
                             Created,
                             Changed,
                             Modified,
                             LastAccessed,
                             Accessor,
                             Data
    FROM chain(async=WORKERS > 0,
      {{ range $idx, $r := .Rules -}}
      {{- if $r.VQL -}}
      {{ $r.Target }}_{{ $r.Name }}={
        SELECT * FROM if(condition={
          SELECT * FROM AllCollections
          WHERE Rule = "{{ $r.Target }}/{{ $r.Name }}"
            AND MaybeLOG(
              Message="Collecting Custom VQL Rule %s",
              Args="{{ $r.Target }}/{{ $r.Name }}")
        }, then={
          SELECT "{{ $r.Target }}/{{ $r.Name }}" AS Type,
                 "{{ $r.Target }}/{{ $r.Name }}" AS Rule,
                 *
          FROM Collect{{ $r.Target }}_{{ $r.Name }}
        })
      },
      {{- end -}}
      {{- end }}
      Globs=AllGlobs
    )
    WHERE log(level="INFO", message="Found %v for rule %v", args=[
              SourceFile, Rule], dedup=10)

    SELECT * FROM AllResults

{{ Template "templates/CommonSources.yaml" }}

{{ Template "templates/ColumnTypes.yaml" }}
